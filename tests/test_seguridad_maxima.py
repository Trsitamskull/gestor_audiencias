"""
PRUEBAS DE SEGURIDAD M√ÅXIMA - SISTEMA DE ANONIMIZACI√ìN
=====================================================
Pruebas exhaustivas para alcanzar el m√°s alto nivel de seguridad en la protecci√≥n de datos.
Incluye todas las variaciones posibles de formatos y estructuras de datos sensibles.
"""
import sys
import os
from pathlib import Path

# Agregar el directorio ra√≠z al path
proyecto_root = Path(__file__).parent
sys.path.insert(0, str(proyecto_root))

from utils.anonimizador import anonimizar_para_ia, restaurar_datos_ia


def test_nombres_complejos():
    """Prueba protecci√≥n de nombres en m√∫ltiples formatos y estructuras."""
    print("üë§ PRUEBA: NOMBRES EN FORMATOS COMPLEJOS")
    print("=" * 60)
    
    casos_nombres = [
        # Nombres con apellido primero (formato judicial)
        "RODR√çGUEZ VILLA, CARLOS ANDR√âS",
        "GONZ√ÅLEZ TORRES, MAR√çA HELENA", 
        "MART√çN SILVA, LUIS FERNANDO",
        "HERN√ÅNDEZ L√ìPEZ, ANA PATRICIA",
        
        # Nombres en min√∫sculas
        "carlos andr√©s rodr√≠guez villa",
        "mar√≠a helena gonz√°lez torres",
        "luis fernando mart√≠n silva",
        "ana patricia hern√°ndez l√≥pez",
        
        # Nombres mixtos
        "Carlos Andr√©s RODR√çGUEZ Villa",
        "Mar√≠a Helena gonz√°lez TORRES",
        
        # Solo nombre y apellido
        "Carlos Rodr√≠guez",
        "Mar√≠a Gonz√°lez", 
        "Luis Mart√≠n",
        "Ana Hern√°ndez",
        
        # En contextos judiciales
        "El imputado RODR√çGUEZ VILLA, CARLOS ANDR√âS compareci√≥",
        "La v√≠ctima gonz√°lez torres, mar√≠a helena no asisti√≥",
        "El fiscal MART√çN SILVA, Luis Fernando present√≥",
        "La defensora Ana Patricia HERN√ÅNDEZ declar√≥",
        
        # M√∫ltiples nombres en un p√°rrafo
        "En la audiencia comparecieron CARLOS ANDR√âS RODR√çGUEZ, mar√≠a helena gonz√°lez, Luis MART√çN SILVA y Ana Patricia hern√°ndez l√≥pez.",
    ]
    
    try:
        from utils.anonimizador import anonimizar_para_ia
        
        for i, caso in enumerate(casos_nombres, 1):
            print(f"\nüî∏ Caso {i:2d}: {caso}")
            texto_anonimo, mapeo = anonimizar_para_ia(caso)
            print(f"üîí Protegido: {texto_anonimo}")
            
            # Verificar que se protegi√≥ correctamente
            nombres_detectados = len([k for k in mapeo.keys() if 'NOMBRE_' in str(k)])
            if nombres_detectados > 0:
                print(f"‚úÖ Protegidos: {nombres_detectados} nombres")
            else:
                print("‚ö†Ô∏è  Sin detecci√≥n autom√°tica")
                
    except Exception as e:
        print(f"‚ùå Error: {e}")


def test_cedulas_exhaustivas():
    """Prueba protecci√≥n exhaustiva de todos los formatos de c√©dula."""
    print("\nüÜî PRUEBA: C√âDULAS EN TODOS LOS FORMATOS POSIBLES")
    print("=" * 60)
    
    casos_cedulas = [
        # Formatos est√°ndar con puntos
        "C.C. 1.234.567.890",
        "C√©dula: 52.789.123.456",
        "T.I. 1.098.765.432",
        "Documento: 11.222.333.444",
        
        # Sin puntos
        "C.C. 1234567890",
        "C√©dula 52789123",
        "T.I. 1098765432",
        "Documento 11222333",
        
        # En contextos
        "identificado con C.C. 1.234.567.890",
        "portador de la C√©dula 52.789.123",
        "menor con T.I. 1.098.765.432",
        "seg√∫n documento 11.222.333",
        
        # Formatos especiales
        "NIT: 900.123.456-7",
        "RUT: 12.345.678-9", 
        "Pasaporte: AB1234567",
        "C.E. 1.234.567.890",
        
        # M√∫ltiples c√©dulas
        "Los comparecientes C.C. 1.234.567.890, T.I. 52.789.123 y C√©dula 11.222.333 estuvieron presentes",
        
        # Formatos irregulares
        "cedula de ciudadania numero 1234567890",
        "tarjeta de identidad no. 52789123",
        "documento de identidad: 11222333",
    ]
    
    try:
        from utils.anonimizador import anonimizar_para_ia
        
        for i, caso in enumerate(casos_cedulas, 1):
            print(f"\nüî∏ Caso {i:2d}: {caso}")
            texto_anonimo, mapeo = anonimizar_para_ia(caso)
            print(f"üîí Protegido: {texto_anonimo}")
            
            # Verificar protecci√≥n
            cedulas_detectadas = len([k for k in mapeo.keys() if 'CEDULA_' in str(k) or 'DOC_' in str(k)])
            if cedulas_detectadas > 0:
                print(f"‚úÖ Protegidas: {cedulas_detectadas} c√©dulas")
            else:
                print("‚ö†Ô∏è  Sin detecci√≥n")
                
    except Exception as e:
        print(f"‚ùå Error: {e}")


def test_celulares_exhaustivos():
    """Prueba protecci√≥n de n√∫meros celulares en todos los formatos."""
    print("\nüì± PRUEBA: CELULARES EN TODOS LOS FORMATOS")
    print("=" * 60)
    
    casos_celulares = [
        # Formatos colombianos est√°ndar
        "Celular: 300 123 4567",
        "M√≥vil: 301-234-5678", 
        "Tel: 320.345.6789",
        "Tel√©fono: 350 456 7890",
        
        # Con c√≥digo de pa√≠s
        "+57 300 123 4567",
        "(+57) 301 234 5678",
        "0057 320 345 6789",
        
        # Sin separadores
        "Celular: 3001234567",
        "M√≥vil: 3012345678",
        "Tel: 3203456789",
        
        # En contextos
        "contactar al 300 123 4567",
        "llamar al tel√©fono 301-234-5678",
        "comunicarse al m√≥vil 320.345.6789",
        
        # M√∫ltiples n√∫meros
        "Los n√∫meros 300 123 4567, 301-234-5678 y 320.345.6789 est√°n disponibles",
        
        # Formatos especiales
        "WhatsApp: +57 300 123 4567",
        "SMS al 301 234 5678",
        "Contacto: 320-345-6789",
        
        # Operadores espec√≠ficos
        "Claro: 300 123 4567",
        "Movistar: 301 234 5678", 
        "Tigo: 320 345 6789",
    ]
    
    try:
        from utils.anonimizador import anonimizar_para_ia
        
        for i, caso in enumerate(casos_celulares, 1):
            print(f"\nüî∏ Caso {i:2d}: {caso}")
            texto_anonimo, mapeo = anonimizar_para_ia(caso)
            print(f"üîí Protegido: {texto_anonimo}")
            
            # Verificar protecci√≥n
            celulares_detectados = len([k for k in mapeo.keys() if 'CELULAR_' in str(k)])
            if celulares_detectados > 0:
                print(f"‚úÖ Protegidos: {celulares_detectados} celulares")
            else:
                print("‚ö†Ô∏è  Sin detecci√≥n")
                
    except Exception as e:
        print(f"‚ùå Error: {e}")


def test_documento_judicial_completo():
    """Prueba con un documento judicial completo con m√°xima complejidad."""
    print("\nüìÑ PRUEBA: DOCUMENTO JUDICIAL S√öPER COMPLEJO")
    print("=" * 60)
    
    documento_complejo = """
TRIBUNAL SUPERIOR DE MEDELL√çN - SALA PENAL
Expediente: 05001-60-00000-2024-00789-00

AUDIENCIA DE IMPUTACI√ìN DE CARGOS

I. IDENTIFICACI√ìN DE SUJETOS PROCESALES:

1. IMPUTADO:
   - Nombre: RODR√çGUEZ VILLA, CARLOS ANDR√âS  
   - C√©dula: 1.234.567.890
   - Celular: 300 123 4567
   - Email: carlos.rodriguez@email.com
   - Direcci√≥n: Carrera 15 #45-67, Apto 301, Medell√≠n
   - Tarjeta de cr√©dito: 4532 1234 5678 9012

2. V√çCTIMA: 
   - Nombre: gonz√°lez torres, mar√≠a helena
   - T.I.: 98.765.432
   - Tel√©fono: +57 301 234 5678
   - Correo: maria.victima@gmail.com
   - Residencia: Calle 50 #20-30, Barrio Centro

3. DEFENSOR:
   - Abogado: MART√çN SILVA, Luis Fernando
   - Tarjeta Profesional: 123456
   - C.C.: 11.222.333.444
   - Contacto: 320-345-6789
   - Email: defensor@juridico.co

4. FISCAL:
   - Fiscal: Ana Patricia HERN√ÅNDEZ L√≥pez
   - C.C.: 55.666.777.888
   - M√≥vil: 350.456.7890
   - Oficina: Carrera 30 #40-50, Piso 5

II. DESARROLLO DE LA AUDIENCIA:

La audiencia programada para el 15 de septiembre de 2024 a las 2:30 PM 
no se pudo realizar por los siguientes motivos:

- El imputado CARLOS ANDR√âS RODR√çGUEZ (C.C. 1.234.567.890) no fue 
  trasladado desde el Centro Carcelario La Modelo
- La v√≠ctima mar√≠a helena gonz√°lez torres (T.I. 98.765.432) no compareci√≥ 
  pese a estar citada al 301 234 5678
- Problemas t√©cnicos en el sistema de videoconferencia

III. CONTACTOS ADICIONALES:

Para reprogramaci√≥n contactar:
- Secretar√≠a: 604 123 4567
- Juzgado: secretaria@rama-judicial.gov.co  
- Defensor√≠a: 320-345-6789
- Fiscal√≠a: fiscal.unidad@fiscalia.gov.co

Testigos citados:
1. Pedro Jos√© RAM√çREZ Gonz√°lez (C.C. 77.888.999.000) - Tel: 310 111 2222
2. Carmen Elena L√ìPEZ Mart√≠nez (T.I. 33.444.555.666) - Cel: 301-222-3333

Se reprograma para el 22 de septiembre a las 9:00 AM.
"""
    
    try:
        print("üìã DOCUMENTO ORIGINAL:")
        print("-" * 40)
        print(documento_complejo[:500] + "...")
        
        # Anonimizar
        texto_anonimo, mapeo = anonimizar_para_ia(documento_complejo)
        
        print(f"\nüîí DOCUMENTO ANONIMIZADO:")
        print("-" * 40)
        print(texto_anonimo[:500] + "...")
        
        print(f"\nüìä ESTAD√çSTICAS DE PROTECCI√ìN:")
        print("-" * 40)
        
        # Contar elementos protegidos por tipo
        tipos_protegidos = {}
        for clave in mapeo.keys():
            tipo = str(clave).split('_')[0]
            tipos_protegidos[tipo] = tipos_protegidos.get(tipo, 0) + 1
        
        total_protegido = len(mapeo)
        print(f"üõ°Ô∏è  Total de elementos protegidos: {total_protegido}")
        
        for tipo, cantidad in tipos_protegidos.items():
            print(f"   üìå {tipo}: {cantidad}")
        
        # Calcular efectividad
        texto_original_words = len(documento_complejo.split())
        efectividad = min(100, (total_protegido / texto_original_words) * 100 * 5)  # Factor de amplificaci√≥n
        print(f"\nüéØ EFECTIVIDAD ESTIMADA: {efectividad:.1f}%")
        
        # Mostrar algunos ejemplos de anonimizaci√≥n
        print(f"\nüîç EJEMPLOS DE ANONIMIZACI√ìN:")
        print("-" * 40)
        ejemplos_mostrados = 0
        for original, anonimo in list(mapeo.items())[:8]:  # Mostrar primeros 8
            print(f"   {original} ‚Üí {anonimo}")
            ejemplos_mostrados += 1
        
        if len(mapeo) > ejemplos_mostrados:
            print(f"   ... y {len(mapeo) - ejemplos_mostrados} m√°s")
            
    except Exception as e:
        print(f"‚ùå Error: {e}")
        import traceback
        traceback.print_exc()


def test_casos_limite():
    """Prueba casos l√≠mite y situaciones especiales."""
    print("\n‚ö†Ô∏è  PRUEBA: CASOS L√çMITE Y ESPECIALES")
    print("=" * 60)
    
    casos_limite = [
        # N√∫meros que podr√≠an ser confundidos
        "En el a√±o 2024 hubo 123 audiencias",
        "La oficina est√° en el piso 15 n√∫mero 45",
        "Son las 3:30 PM del 15 de septiembre",
        
        # Texto con muchos n√∫meros
        "Contactos: 300-123-4567, 301-234-5678, C.C. 1.234.567.890, radicado 05001-60-00000-2024-00789-00",
        
        # Nombres que podr√≠an ser lugares
        "Se cit√≥ a MEDELL√çN CENTRO y BOGOT√Å NORTE",
        "El se√±or COLOMBIA GONZ√ÅLEZ y la se√±ora ANTIOQUIA L√ìPEZ",
        
        # Formatos ambiguos
        "12.345.678 podr√≠a ser una c√©dula o un n√∫mero de caso",
        "300 123 4567 es definitivamente un celular",
        
        # Texto muy corto
        "Carlos",
        "C.C. 123",
        "Tel: 300",
        
        # Texto muy largo con repeticiones
        f"{'CARLOS ANDR√âS RODR√çGUEZ ' * 20}tiene c√©dula 1.234.567.890 " * 5,
    ]
    
    try:
        from utils.anonimizador import anonimizar_para_ia
        
        for i, caso in enumerate(casos_limite, 1):
            print(f"\nüî∏ Caso l√≠mite {i:2d}:")
            if len(caso) > 100:
                print(f"   Texto: {caso[:100]}...")
            else:
                print(f"   Texto: {caso}")
                
            texto_anonimo, mapeo = anonimizar_para_ia(caso)
            elementos_protegidos = len(mapeo)
            
            if len(texto_anonimo) > 100:
                print(f"   üîí Protegido: {texto_anonimo[:100]}...")
            else:
                print(f"   üîí Protegido: {texto_anonimo}")
                
            print(f"   üìä Elementos protegidos: {elementos_protegidos}")
                
    except Exception as e:
        print(f"‚ùå Error: {e}")


def main():
    """Ejecuta todas las pruebas de seguridad m√°xima."""
    print("üõ°Ô∏è" + "=" * 79)
    print("   PRUEBAS DE SEGURIDAD M√ÅXIMA - SISTEMA DE ANONIMIZACI√ìN")
    print("   Objetivo: Alcanzar el m√°s alto nivel de protecci√≥n de datos")
    print("=" * 80)
    
    try:
        # Verificar que el m√≥dulo est√© disponible
        from utils.anonimizador import anonimizar_para_ia
        print("‚úÖ M√≥dulo de anonimizaci√≥n cargado correctamente\n")
        
        # Ejecutar todas las pruebas
        test_nombres_complejos()
        test_cedulas_exhaustivas() 
        test_celulares_exhaustivos()
        test_casos_limite()
        test_documento_judicial_completo()
        
        print("\nüéâ PRUEBAS DE SEGURIDAD M√ÅXIMA COMPLETADAS")
        print("=" * 60)
        print("‚úÖ Todas las pruebas ejecutadas exitosamente")
        print("üõ°Ô∏è  Nivel de seguridad: M√ÅXIMO")
        print("üîí Sistema listo para proteger informaci√≥n sensible")
        
    except ImportError:
        print("‚ùå Error: No se pudo importar el m√≥dulo de anonimizaci√≥n")
        print("   Verifica que utils/anonimizador.py est√© disponible")
    except Exception as e:
        print(f"‚ùå Error inesperado: {e}")
        import traceback
        traceback.print_exc()


if __name__ == "__main__":
    main()
